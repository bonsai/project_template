<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>みらい枠</title>
<style>
:root {
  --primary: #34C759;
  --bg: #000000;
  --surface: #1C1C1E;
  --text-main: #FFFFFF;
  --text-secondary: #8E8E93;
  --separator: #38383A;
  --radius-l: 22px;
  --radius-m: 14px;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
  background-color: var(--bg);
  color: var(--text-main);
  -webkit-font-smoothing: antialiased;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding-top: max(20px, env(safe-area-inset-top));
}

.app-container {
  width: 100%;
  max-width: 440px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 32px;
}

/* Header */
header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin-top: 10px;
}

.app-icon {
  width: 64px;
  height: 64px;
  background: linear-gradient(180deg, #2C2C2E 0%, #1C1C1E 100%);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  border: 1px solid rgba(255,255,255,0.1);
}

h1 {
  font-size: 28px;
  font-weight: 700;
  margin: 0;
  letter-spacing: 0.3px;
}

.subtitle {
  font-size: 15px;
  color: var(--text-secondary);
  font-weight: 400;
  margin: 0;
}

/* Card */
.card {
  background: var(--surface);
  border-radius: var(--radius-l);
  padding: 24px;
  position: relative;
}

/* Dropzone */
.dropzone {
  border: 2px dashed var(--separator);
  border-radius: var(--radius-m);
  padding: 48px 20px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  background: rgba(255,255,255,0.01);
}

.dropzone.is-dragover {
  border-color: var(--primary);
  background: rgba(52, 199, 89, 0.08);
  transform: scale(0.98);
}

.dropzone-icon {
  color: var(--text-secondary);
  margin-bottom: 16px;
  opacity: 0.8;
}

.dropzone p {
  margin: 0;
  font-size: 17px;
  font-weight: 600;
  color: var(--text-main);
}

.dropzone .sub-text {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 6px;
}

/* Controls */
.controls {
  display: flex;
  background: #2C2C2E;
  padding: 4px;
  border-radius: 999px;
  margin-top: 24px;
}

.shape-option {
  flex: 1;
  position: relative;
}

.shape-option input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.shape-label {
  display: block;
  text-align: center;
  padding: 10px 0;
  font-size: 13px;
  font-weight: 600;
  border-radius: 999px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.shape-option input:checked + .shape-label {
  background: #636366;
  color: white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* Result Area */
#result {
  min-height: 100px;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* Badge */
.badge {
  display: inline-flex;
  align-items: center;
  font-size: 11px;
  font-weight: 600;
  color: var(--primary);
  background: rgba(52, 199, 89, 0.12);
  padding: 6px 12px;
  border-radius: 999px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Helpers */
.text-center { text-align: center; }

@media (max-width: 480px) {
  .app-container {
    padding: 16px;
    gap: 24px;
  }
}
</style>
</head>
<body>

<div class="app-container">
  <header>
    <div class="badge">チームみらい応援</div>
    <div class="app-icon">
       <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
         <circle cx="16" cy="16" r="16" fill="#34C759" fill-opacity="0.1"/>
         <path d="M16 6C10.4772 6 6 10.4772 6 16C6 21.5228 10.4772 26 16 26C21.5228 26 26 21.5228 26 16" stroke="#34C759" stroke-width="2.5" stroke-linecap="round"/>
       </svg>
    </div>
    <div class="text-center">
      <h1>みらい枠</h1>
    </div>
  </header>

  <main class="card">
    <div id="dropzone" class="dropzone">
      <div class="dropzone-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#34C759" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
      </div>
    </div>
    <input type="file" id="file" accept="image/*" hidden>

    <div class="controls">
      <label class="shape-option">
        <input type="radio" name="shape" value="square" checked>
        <span class="shape-label">スクエア</span>
      </label>
      <label class="shape-option">
        <input type="radio" name="shape" value="circle">
        <span class="shape-label">サークル</span>
      </label>
    </div>
  </main>

  <div id="result-area">
    <div id="result"></div>
  </div>

</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
const MAX_SIZE = 5 * 1024 * 1024;
let currentFile = null;

const $fileInput = $('#file');
const $result = $('#result');
const $dropzone = $('#dropzone');

function setResultMessage(html) {
  $result.html(html);
}

function handleFile(file) {
  if (!file) return;
  if (!file.type.startsWith('image/')) {
    setResultMessage('<p style="color:#FF453A; text-align:center;">画像ファイルを選択してください。</p>');
    return;
  }

  if (file.size > MAX_SIZE) {
    setResultMessage('<p style="color:#FF453A; text-align:center;">5MB以下にしてください。</p>');
    return;
  }

  currentFile = file;
  setResultMessage('<p style="text-align:center; color:#8E8E93;">処理中...</p>');

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      canvas.toBlob(function(blob) {
        if (blob.size > MAX_SIZE) {
          setResultMessage('<p style="color:#FF453A; text-align:center;">5MBを超えました。</p>');
          return;
        }

        const formData = new FormData();
        formData.append("image", blob, "converted.png");
        formData.append("shape", $('input[name="shape"]:checked').val());

        $.ajax({
          url: "/api/upload",
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (html) {
            $result.html(html);
          },
          error: function(xhr) {
            setResultMessage('<p style="color:#FF453A; text-align:center;">エラーが発生しました。</p>');
          }
        });
      }, 'image/png');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

$dropzone.on('click', function() {
  $fileInput.click();
});

$fileInput.on('change', function () {
  handleFile(this.files[0]);
});

$dropzone.on('dragenter dragover', function(e) {
  e.preventDefault();
  e.stopPropagation();
  $dropzone.addClass('is-dragover');
});

$dropzone.on('dragleave drop', function(e) {
  e.preventDefault();
  e.stopPropagation();
  $dropzone.removeClass('is-dragover');
});

$dropzone.on('drop', function(e) {
  const file = e.originalEvent.dataTransfer.files[0];
  handleFile(file);
});

$('input[name="shape"]').on('change', function() {
  if (currentFile) {
    handleFile(currentFile);
  }
});
</script>
</body>
</html>