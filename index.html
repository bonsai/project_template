<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>みらい枠ジェネレーター</title>
<style>
:root {
  --mint: #89C997;
  --mint-strong: #6AE7B8;
  --mint-dark: #5EB28B;
  --ink: #E7F3EC;
  --muted: #A0B7AB;
  --bg: #0D1312;
  --panel: #121A18;
  --panel-soft: #17201E;
  --shadow: 0 22px 50px rgba(5, 10, 9, 0.45);
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
  background: radial-gradient(circle at top, rgba(106, 231, 184, 0.18), transparent 45%), linear-gradient(180deg, #0B1211 0%, #0F1715 100%);
  color: var(--ink);
  min-height: 100vh;
}
.app-shell {
  max-width: 520px;
  margin: 0 auto;
  padding: 28px 16px 56px;
}
.app-header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  border-radius: 22px;
  background: linear-gradient(135deg, rgba(24, 34, 31, 0.95), rgba(18, 27, 24, 0.98));
  box-shadow: var(--shadow);
  border: 1px solid rgba(106, 231, 184, 0.16);
  margin-bottom: 18px;
}
.app-icon {
  width: 54px;
  height: 54px;
  border-radius: 16px;
  background: linear-gradient(140deg, #7FE0B2 0%, #58B98C 100%);
  display: grid;
  place-items: center;
  box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.2);
}
.app-title-block {
  flex: 1;
}
.app-title {
  font-size: 20px;
  font-weight: 800;
  margin: 6px 0 4px;
}
.app-sub {
  font-size: 12px;
  color: var(--muted);
  margin: 0;
}
.app-badge {
  display: inline-flex;
  align-items: center;
  background: rgba(106, 231, 184, 0.2);
  color: var(--mint-strong);
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
}
.card {
  background: var(--panel);
  border-radius: 24px;
  box-shadow: var(--shadow);
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.06);
}
.dropzone {
  border: 2px dashed rgba(106, 231, 184, 0.5);
  border-radius: 20px;
  padding: 22px;
  display: flex;
  align-items: center;
  gap: 16px;
  background: var(--panel-soft);
  transition: all 0.2s ease;
}
.dropzone.is-dragover {
  border-color: var(--mint-strong);
  background: rgba(106, 231, 184, 0.14);
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(106, 231, 184, 0.2);
}
.dropzone-icon {
  width: 64px;
  height: 64px;
  flex: 0 0 64px;
  background: linear-gradient(140deg, #7FE0B2 0%, #58B98C 100%);
  border-radius: 18px;
  display: grid;
  place-items: center;
  box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.2);
}
.dropzone-body {
  flex: 1;
}
.dropzone-title {
  font-weight: 700;
  margin: 0 0 6px;
  font-size: 16px;
}
.dropzone-text {
  margin: 0;
  font-size: 12px;
  color: var(--muted);
}
.file-actions {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 12px;
}
.file-button {
  background: linear-gradient(135deg, #7FE0B2, #58B98C);
  color: #07110E;
  border: none;
  border-radius: 999px;
  padding: 12px 18px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 10px 24px rgba(106, 231, 184, 0.25);
  text-align: center;
  flex: 1;
}
.file-name {
  font-size: 12px;
  color: var(--muted);
  text-align: right;
  flex: 1;
}
.shape-group {
  display: flex;
  gap: 10px;
  margin-top: 18px;
}
.shape-option {
  position: relative;
  flex: 1;
}
.shape-option input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}
.shape-pill {
  display: block;
  text-align: center;
  padding: 12px 12px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.06);
  font-weight: 700;
  color: var(--muted);
  border: 2px solid rgba(255, 255, 255, 0.08);
  cursor: pointer;
  transition: all 0.2s ease;
}
.shape-option input:checked + .shape-pill {
  background: linear-gradient(135deg, #7FE0B2, #58B98C);
  color: #04110D;
  border-color: transparent;
  box-shadow: 0 10px 22px rgba(106, 231, 184, 0.28);
}
.result {
  min-height: 160px;
  border-radius: 18px;
  padding: 16px;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 255, 255, 0.08);
}
.result p {
  margin: 0;
}
.helper {
  font-size: 12px;
  color: var(--muted);
  margin-top: 12px;
  text-align: center;
}
.result-card {
  margin-top: 16px;
}
@media (max-width: 560px) {
  .app-shell {
    padding: 18px 14px 40px;
  }
  .app-header {
    padding: 14px;
  }
  .app-title {
    font-size: 18px;
  }
  .dropzone {
    flex-direction: column;
    text-align: center;
  }
  .file-actions {
    flex-direction: column;
  }
  .file-name {
    text-align: center;
  }
}
</style>
</head>
<body>

<div class="app-shell">
  <header class="app-header">
    <div class="app-icon">
      <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="34" height="34">
        <rect x="28" y="28" width="144" height="144" rx="30" fill="#0D1312" opacity="0.2"/>
        <rect x="44" y="44" width="112" height="112" rx="26" fill="#DDF7EA"/>
        <circle cx="100" cy="94" r="34" fill="#FFFFFF"/>
        <path d="M74 122C83 111 92 106 100 106C108 106 117 111 126 122" stroke="#5EB28B" stroke-width="10" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="app-title-block">
      <span class="app-badge">チームみらい応援</span>
      <h1 class="app-title">みらい枠</h1>
      <p class="app-sub">タップかドロップ</p>
    </div>
  </header>

  <div class="card">
    <div id="dropzone" class="dropzone">
      <div class="dropzone-icon">
        <svg viewBox="0 0 64 64" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M32 10L18 26H26V42H38V26H46L32 10Z" fill="#FFFFFF"/>
          <rect x="14" y="44" width="36" height="8" rx="4" fill="#FFFFFF"/>
        </svg>
      </div>
      <div class="dropzone-body">
        <p class="dropzone-title">ここに置く</p>
        <p class="dropzone-text">タップで選ぶ</p>
        <div class="file-actions">
          <label class="file-button" for="file">画像を選ぶ</label>
          <span id="fileName" class="file-name">未選択</span>
        </div>
      </div>
    </div>

    <input type="file" id="file" accept="image/*" hidden>

    <div class="shape-group">
      <label class="shape-option">
        <input type="radio" name="shape" value="square" checked>
        <span class="shape-pill">四角</span>
      </label>
      <label class="shape-option">
        <input type="radio" name="shape" value="circle">
        <span class="shape-pill">丸</span>
      </label>
    </div>
  </div>

  <div class="card result-card">
    <div id="result" class="result"></div>
    <p class="helper">保存ボタンが出ます</p>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
const MAX_SIZE = 0.5 * 1024 * 1024;
let currentFile = null;

const $fileInput = $('#file');
const $result = $('#result');
const $fileName = $('#fileName');
const $dropzone = $('#dropzone');

function setResultMessage(html) {
  $result.html(html);
}

function handleFile(file) {
  if (!file) return;
  if (!file.type.startsWith('image/')) {
    setResultMessage('<p style="color:red; text-align:center;">画像ファイルを選択してください。</p>');
    return;
  }

  if (file.size > MAX_SIZE) {
    setResultMessage('<p style="color:red; text-align:center;">ファイルサイズは0.5MB以下にしてください。</p>');
    return;
  }

  currentFile = file;
  $fileName.text(file.name);
  setResultMessage('<p style="text-align:center;">画像を変換・送信中...</p>');

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      canvas.toBlob(function(blob) {
        if (blob.size > MAX_SIZE) {
          setResultMessage('<p style="color:red; text-align:center;">変換後の画像サイズが0.5MBを超えました。<br>より小さい画像を使用してください。</p>');
          return;
        }

        const formData = new FormData();
        formData.append("image", blob, "converted.png");
        formData.append("shape", $('input[name="shape"]:checked').val());

        $.ajax({
          url: "/api/upload",
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (html) {
            $result.html(html);
          },
          error: function(xhr) {
            let msg = 'エラーが発生しました。';
            if (xhr.responseText) {
              msg += '<br><small style="color:#666; font-family:monospace; display:block; margin-top:10px; text-align:left; background:#eee; padding:10px; border-radius:4px;">' +
                     xhr.responseText.replace(/\n/g, '<br>') + '</small>';
            }
            setResultMessage('<p style="color:red; text-align:center;">' + msg + '</p>');
          }
        });
      }, 'image/png');
    };
    img.onerror = function() {
      setResultMessage('<p style="color:red; text-align:center;">画像の読み込みに失敗しました。</p>');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

$fileInput.on('change', function () {
  const file = this.files[0];
  handleFile(file);
});

$dropzone.on('dragenter dragover', function(e) {
  e.preventDefault();
  e.stopPropagation();
  $dropzone.addClass('is-dragover');
});

$dropzone.on('dragleave', function(e) {
  e.preventDefault();
  e.stopPropagation();
  $dropzone.removeClass('is-dragover');
});

$dropzone.on('drop', function(e) {
  e.preventDefault();
  e.stopPropagation();
  $dropzone.removeClass('is-dragover');
  const file = e.originalEvent.dataTransfer.files[0];
  handleFile(file);
});

$('input[name="shape"]').on('change', function() {
  if (currentFile) {
    handleFile(currentFile);
  }
});
</script>

</body>
</html>
