<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>枠付き画像ジェネレーター</title>
<style>
#preview {
  max-width: 300px;
  margin-top: 20px;
}
</style>
</head>
<body>

<h2>画像アップロード（枠付き自動合成）</h2>

<input type="file" id="file" accept="image/*">

<div>
  <label><input type="radio" name="shape" value="square" checked> 四角</label>
  <label><input type="radio" name="shape" value="circle"> 丸</label>
</div>

<div id="result">
        <!-- Result will be loaded here -->
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
    $('#file').on('change', function () {
        const file = this.files[0];
        if (!file) return;

        // Check file size (Initial check for obvious large files)
        const MAX_SIZE = 0.5 * 1024 * 1024;
        if (file.size > MAX_SIZE) {
            alert('ファイルサイズは0.5MB以下にしてください。');
            $(this).val(''); 
            $('#result').empty(); 
            return;
        }

        // Show loading state
        $('#result').html('<p style="text-align:center;">画像を変換・送信中...</p>');

        // Convert to PNG using Canvas to ensure compatibility with backend (chunky_png)
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                // Convert to PNG blob
                canvas.toBlob(function(blob) {
                    // Check converted size
                    if (blob.size > MAX_SIZE) {
                        $('#result').html('<p style="color:red; text-align:center;">変換後の画像サイズが0.5MBを超えました。<br>より小さい画像を使用してください。</p>');
                        return;
                    }

                    const formData = new FormData();
                    formData.append("image", blob, "converted.png");
                    formData.append("shape", $('input[name="shape"]:checked').val());

                    $.ajax({
                        url: "/api/upload",
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (html) {
                            $('#result').html(html);
                        },
                        error: function(xhr, status, error) {
                            console.error("Error details:", xhr);
                            let msg = 'エラーが発生しました。';
                            if (xhr.responseText) {
                                msg += '<br><small style="color:#666; font-family:monospace; display:block; margin-top:10px; text-align:left; background:#eee; padding:10px; border-radius:4px;">' + 
                                       xhr.responseText.replace(/\n/g, '<br>') + '</small>';
                            }
                            $('#result').html('<p style="color:red; text-align:center;">' + msg + '</p>');
                        }
                    });
                }, 'image/png');
            };
            img.onerror = function() {
                $('#result').html('<p style="color:red; text-align:center;">画像の読み込みに失敗しました。</p>');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
    
    // Also trigger update when shape changes if file is selected
    $('input[name="shape"]').on('change', function() {
        if ($('#file')[0].files.length > 0) {
            $('#file').trigger('change');
        }
    });
    </script>

</body>
</html>
